#!/usr/bin/env bash
set -e

: "${GRAFANA_CHART_VERSION:=9.3.0}" # Grafana v12.1.0
: "${K8SAPP_APPLICATION_VERSION:=$GRAFANA_CHART_VERSION}"

out=manifests/base/grafana.yaml

# TODO add proxy env vars

# shellcheck disable=SC2317
cleanup-grafana() {
	echo "Cleaning up grafana pull"
	rm -rf grafana
	#rm "$out"
}
trap cleanup-grafana INT EXIT TERM

helm repo add grafana "https://grafana.github.io/helm-charts"
helm repo update

helm pull grafana/grafana --untar \
	--version "$GRAFANA_CHART_VERSION"
mkdir -p "resources/values/grafana"
mv "grafana/values.yaml" "resources/values/grafana/defaults.yaml"

# Pull down and modify templates
helm template grafana grafana/grafana \
	--values resources/values/grafana/values.yaml \
	--version "$GRAFANA_CHART_VERSION" \
	--namespace grafana \
	>"$out"

# TODO Convert all Secrets to ExternalSecrets
#secret_names=$(yq 'select(.kind == "Secret")| .metadata.name' "$out")
#for name in $secret_names; do
#	echo "$name"
#done

# TODO Remove all Secrets
#yq -i 'select(.kind != "Secret")' "$out"
